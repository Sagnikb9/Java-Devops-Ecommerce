package com.Controller;

import java.util.List;
import java.util.Properties;

import javax.mail.Authenticator;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.PasswordAuthentication;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;

import com.dao.UserDao;
import com.model.User;

@Controller
public class RegisterController {

	
	@Autowired
	UserDao userDao;
	
	@RequestMapping(value="/",method=RequestMethod.POST)
	public String Register(@RequestParam("username")String username,
			                        @RequestParam("password")String password,
			                        @RequestParam("enabled")Boolean enabled,
			                        @RequestParam("role")String role,Model m)
	{
		
		
			
		
			
		 
		
		
		User user=new User();
		user.setUsername(username);
		user.setPassword(password);
		user.setEnabled(true);
		user.setRole(role);
		if(userDao.addUser(user));
		{
			List<User>listUser=userDao.retrieveUser();
			m.addAttribute("userList",listUser);
			

			  String host="smtp.gmail.com";  
			  final String fromEmail = "donotreply.medioxypharm@gmail.com";//change accordingly  
			  final String password1="medioxy0139@pharm";//change accordingly  
			    
			  String toEmail=username;//change accordingly  
			  
			   //Get the session object  
			   Properties props = new Properties();  
			   props.put("mail.smtp.host",host);
			   props.put("mail.smtp.port", "465");
			   props.put("mail.smtp.auth", "true");
			   props.put("mail.smtp.user", username);
			     
			   Session session = Session.getInstance(props,  
			    new javax.mail.Authenticator() {  
			      protected PasswordAuthentication getPasswordAuthentication() {  
			    return new PasswordAuthentication(fromEmail,password1);  
			      }  
			    });  
			  
			   //Compose the message  
			    try 
			    {  
			     Message message = new MimeMessage(session);  
			     message.setFrom(new InternetAddress(fromEmail));  
			     message.addRecipient(Message.RecipientType.TO,new InternetAddress(toEmail));  
			     message.setSubject("Hi,"+username+":"+"MedioxyPharm Account created successfully");  
			     message.setText("Please do not reply.This is a autogenerated message");  
			       
			    //send the message  
			        Transport t = session.getTransport("smtp");
			        t.connect(username, password1);
			        t.sendMessage(message, message.getAllRecipients());
			        t.close();
			        
			  
			     System.out.println("message sent successfully...");  
			   
			     }  
			    catch (MessagingException e) 
			    {
			    	e.printStackTrace();
	 
		        }
		return "index";
		
		
	}
	
	}
}
	
	
	

